<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.231">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Longitudinal Analysis for Surveillance - 6&nbsp; Panel data: multiple areas with autocorrelation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../qmd/700-exercises.html" rel="next">
<link href="../qmd/500-multiple-areas-no-autocorrelation.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>
    .quarto-title-block .quarto-title-banner {
      color: #000000;
background: #b8e2f2;
    }
    </style>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Panel data: multiple areas with autocorrelation</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title d-none d-lg-block"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Panel data: multiple areas with autocorrelation</span></h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="https://www.csids.no/resources.html">csids.no</a>
        <div class="sidebar-tools-main">
    <a href="https://github.com/csids/longitudinal-analysis-for-surveillance" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Longitudinal Analysis for Surveillance</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/100-reference.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Reference</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/200-one-area-no-autocorrelation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Panel data: One area without autocorrelation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/300-one-area-with-autocorrelation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Panel data: One area with autocorrelation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/400-multiple-areas-no-panel-data.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Not panel data: Multiple areas</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/500-multiple-areas-no-autocorrelation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Panel data: multiple areas without autocorrelation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/600-multiple-areas-with-autocorrelation.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Panel data: multiple areas with autocorrelation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/700-exercises.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Exercises</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../qmd/800-solutions.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Solutions</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#aim" id="toc-aim" class="nav-link active" data-scroll-target="#aim"><span class="toc-section-number">6.1</span>  Aim</a></li>
  <li><a href="#creating-the-data" id="toc-creating-the-data" class="nav-link" data-scroll-target="#creating-the-data"><span class="toc-section-number">6.2</span>  Creating the data</a></li>
  <li><a href="#investigation" id="toc-investigation" class="nav-link" data-scroll-target="#investigation"><span class="toc-section-number">6.3</span>  Investigation</a></li>
  <li><a href="#regressions" id="toc-regressions" class="nav-link" data-scroll-target="#regressions"><span class="toc-section-number">6.4</span>  Regressions</a></li>
  <li><a href="#residual-analysis" id="toc-residual-analysis" class="nav-link" data-scroll-target="#residual-analysis"><span class="toc-section-number">6.5</span>  Residual analysis</a></li>
  <li><a href="#r-only-regression-with-ar1-correlation-in-residuals" id="toc-r-only-regression-with-ar1-correlation-in-residuals" class="nav-link" data-scroll-target="#r-only-regression-with-ar1-correlation-in-residuals"><span class="toc-section-number">6.6</span>  (R ONLY) Regression with AR(1) correlation in residuals</a></li>
  <li><a href="#residual-analysis-1" id="toc-residual-analysis-1" class="nav-link" data-scroll-target="#residual-analysis-1"><span class="toc-section-number">6.7</span>  Residual analysis</a></li>
  <li><a href="#stata-only-regression-with-robust-standard-errors" id="toc-stata-only-regression-with-robust-standard-errors" class="nav-link" data-scroll-target="#stata-only-regression-with-robust-standard-errors"><span class="toc-section-number">6.8</span>  (STATA ONLY) Regression with robust standard errors</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/csids/longitudinal-analysis-for-surveillance/edit/main/qmd/600-multiple-areas-with-autocorrelation.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/csids/longitudinal-analysis-for-surveillance/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="aim" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="aim"><span class="header-section-number">6.1</span> Aim</h2>
<p>We are given a dataset containing daily counts of diseases from multiple geographical areas. We want to identify:</p>
<ul>
<li>Does seasonality exist?</li>
<li>If seasonality exists, when are the high/low seasons?</li>
<li>Is there a general yearly trend (i.e.&nbsp;increasing or decreasing from year to year?)</li>
</ul>
<div style="page-break-after: always;"></div>
</section>
<section id="creating-the-data" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="creating-the-data"><span class="header-section-number">6.2</span> Creating the data</h2>
<p>The data for this chapter is available at: https://www.csids.no/longitudinal-analysis-for-surveillance/data/chapter_7.csv</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>AMPLITUDE <span class="ot">&lt;-</span> <span class="fl">1.5</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>SEASONAL_HORIZONTAL_SHIFT <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>fylkeIntercepts <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">fylke=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,<span class="at">fylkeIntercepts=</span><span class="fu">rnorm</span>(<span class="dv">20</span>))</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">date=</span><span class="fu">seq.Date</span>(</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">from=</span><span class="fu">as.Date</span>(<span class="st">"2010-01-01"</span>),</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">to=</span><span class="fu">as.Date</span>(<span class="st">"2015-12-31"</span>),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">by=</span><span class="dv">1</span>))</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>d[,year<span class="sc">:</span><span class="er">=</span><span class="fu">as.numeric</span>(<span class="fu">format.Date</span>(date,<span class="st">"%G"</span>))]</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>d[,week<span class="sc">:</span><span class="er">=</span><span class="fu">as.numeric</span>(<span class="fu">format.Date</span>(date,<span class="st">"%V"</span>))]</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>d[,month<span class="sc">:</span><span class="er">=</span><span class="fu">as.numeric</span>(<span class="fu">format.Date</span>(date,<span class="st">"%m"</span>))]</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>,<span class="at">length=</span><span class="dv">20</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>){</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  temp[[i]] <span class="ot">&lt;-</span> <span class="fu">copy</span>(d)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  temp[[i]][,fylke<span class="sc">:</span><span class="er">=</span>i]</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(temp)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>d[,yearMinus2000<span class="sc">:</span><span class="er">=</span>year<span class="dv">-2000</span>]</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>d[,dayOfSeries<span class="sc">:</span><span class="er">=</span><span class="dv">1</span><span class="sc">:</span>.N]</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>d[,dayOfYear<span class="sc">:</span><span class="er">=</span><span class="fu">as.numeric</span>(<span class="fu">format.Date</span>(date,<span class="st">"%j"</span>))]</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>d[,seasonalEffect<span class="sc">:</span><span class="er">=</span><span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span>(dayOfYear<span class="sc">-</span>SEASONAL_HORIZONTAL_SHIFT)<span class="sc">/</span><span class="dv">365</span>)]</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>d[,mu <span class="sc">:</span><span class="er">=</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fl">0.1</span> <span class="sc">+</span> yearMinus2000<span class="sc">*</span><span class="fl">0.1</span> <span class="sc">+</span> seasonalEffect<span class="sc">*</span>AMPLITUDE))]</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>d[,y<span class="sc">:</span><span class="er">=</span><span class="fu">rpois</span>(.N,mu)]</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>d[,y<span class="sc">:</span><span class="er">=</span>mu<span class="sc">+</span><span class="fu">round</span>(<span class="fu">as.numeric</span>(<span class="fu">arima.sim</span>(<span class="at">model=</span><span class="fu">list</span>(<span class="st">"ar"</span><span class="ot">=</span><span class="fu">c</span>(<span class="fl">0.5</span>)), <span class="at">rand.gen =</span> rpois, <span class="at">n=</span><span class="fu">nrow</span>(d), <span class="at">lambda=</span>mu)))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="investigation" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="investigation"><span class="header-section-number">6.3</span> Investigation</h2>
<p>We drill down into a few years in fylke 1, and see a clear seasonal trend</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(d[fylke<span class="sc">==</span><span class="dv">1</span>],<span class="fu">aes</span>(<span class="at">x=</span>dayOfYear,<span class="at">y=</span>y))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> q <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>year)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> q <span class="sc">+</span> <span class="fu">geom_point</span>()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> q <span class="sc">+</span> <span class="fu">stat_smooth</span>(<span class="at">colour=</span><span class="st">"red"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>q</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'loess' and formula 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<p><img src="600-multiple-areas-with-autocorrelation_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div style="page-break-after: always;"></div>
<p>The Lomb-Scargle Periodogram shows a clear seasonality with a period of 365 days</p>
<pre><code>// STATA CODE STARTS
insheet using "chapter_7.csv", clear

sort fylke date
by fylke: gen time=_n
tsset fylke time, daily

wntestb y if fylke==1

cumsp y if fylke==1, gen(cumulative_spec_dist)
by fylke: gen period=_N/_n

browse cumulative_spec_dist period
// STATA CODE ENDS</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R CODE</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>lomb<span class="sc">::</span><span class="fu">lsp</span>(d<span class="sc">$</span>y,<span class="at">from=</span><span class="dv">100</span>,<span class="at">to=</span><span class="dv">500</span>,<span class="at">ofac=</span><span class="dv">1</span>,<span class="at">type=</span><span class="st">"period"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="600-multiple-areas-with-autocorrelation_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="regressions" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="regressions"><span class="header-section-number">6.4</span> Regressions</h2>
<p>First we create an <code>id</code> variable. This generally corresponds to geographical locations, or people. In this case, we only have one geographical location, so our <code>id</code> for all observations is <code>1</code>. This lets the computer know that all data belongs to the same group.</p>
<p>When we have panel data with multiple areas, we use the <code>MASS::glmPQL</code> function in R and the <code>meglm</code> function in STATA. In R we identify the geographical areas with <code>random = ~ § | fylke</code> and in STATA with <code>|| fylke:</code>.</p>
<pre><code>// STATA CODE STARTS
gen cos365=cos(dayofyear*2*_pi/365)
gen sin365=sin(dayofyear*2*_pi/365)

meglm y yearminus2000 || fylke:, family(poisson) iter(10)
estimates store m1
meglm y yearminus2000 cos365 sin365 || fylke:, family(poisson) iter(10)
estimates store m2

predict resid, anscombe

lrtest m1 m2
// STATA CODE ENDS</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R CODE</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>d[,cos365<span class="sc">:</span><span class="er">=</span><span class="fu">cos</span>(dayOfYear<span class="sc">*</span><span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">365</span>)]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>d[,sin365<span class="sc">:</span><span class="er">=</span><span class="fu">sin</span>(dayOfYear<span class="sc">*</span><span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">365</span>)]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>fit0 <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">glmmPQL</span>(y<span class="sc">~</span>yearMinus2000, <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> fylke,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> poisson, <span class="at">data =</span> d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>iteration 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">glmmPQL</span>(y<span class="sc">~</span>yearMinus2000 <span class="sc">+</span> sin365 <span class="sc">+</span> cos365, <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> fylke,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> poisson, <span class="at">data =</span> d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>iteration 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>iteration 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(lmtest<span class="sc">::</span><span class="fu">lrtest</span>(fit0, fit1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Likelihood ratio test

Model 1: y ~ yearMinus2000
Model 2: y ~ yearMinus2000 + sin365 + cos365
  #Df LogLik Df Chisq Pr(&gt;Chisq)
1   4                           
2   6         2                 </code></pre>
</div>
</div>
<p>We see that the likelihood ratio test for <code>sin365</code> and <code>cos365</code> was significant, meaning that there is significant seasonality with a 365 day periodicity in our data (which we already strongly suspected due to the periodogram).</p>
<div style="page-break-after: always;"></div>
<p>We can now run/look at the results of our main regression.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(fit1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by maximum likelihood
  Data: d 
  AIC BIC logLik
   NA  NA     NA

Random effects:
 Formula: ~1 | fylke
        (Intercept)  Residual
StdDev: 0.004579768 0.7191519

Variance function:
 Structure: fixed weights
 Formula: ~invwt 
Fixed effects:  y ~ yearMinus2000 + sin365 + cos365 
                   Value   Std.Error    DF   t-value p-value
(Intercept)    1.2189925 0.006110555 43797  199.4896       0
yearMinus2000  0.0987374 0.000461394 43797  213.9980       0
sin365         1.3990267 0.001531179 43797  913.6928       0
cos365        -0.5171211 0.001282191 43797 -403.3106       0
 Correlation: 
              (Intr) yM2000 sin365
yearMinus2000 -0.966              
sin365        -0.147  0.000       
cos365         0.065 -0.001 -0.152

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-3.00864057 -0.70228031 -0.06334676  0.64274011  5.21710224 

Number of Observations: 43820
Number of Groups: 20 </code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="residual-analysis" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="residual-analysis"><span class="header-section-number">6.5</span> Residual analysis</h2>
<p>We see that there is an <code>AR(1)</code> autocorrelation in the residuals, meaning that our model is not appropriate.</p>
<pre><code>// STATA CODE STARTS
pac resid if fylke==1
// STATA CODE ENDS</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R CODE</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pacf</span>(<span class="fu">residuals</span>(fit1, <span class="at">type =</span> <span class="st">"normalized"</span>)) <span class="co"># this is for AR</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="600-multiple-areas-with-autocorrelation_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div style="page-break-after: always;"></div>
<p>We see that there is some sort of <code>AR</code> autocorrelation in the residuals, meaning that our model is not appropriate.</p>
<pre><code>// STATA CODE STARTS
ac resid if fylke==1
// STATA CODE ENDS</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R CODE</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">residuals</span>(fit1, <span class="at">type =</span> <span class="st">"normalized"</span>)) <span class="co"># this is for MA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="600-multiple-areas-with-autocorrelation_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="r-only-regression-with-ar1-correlation-in-residuals" class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="r-only-regression-with-ar1-correlation-in-residuals"><span class="header-section-number">6.6</span> (R ONLY) Regression with AR(1) correlation in residuals</h2>
<p>We include <code>correlation=nlme::corAR1(form=~dayOfSeries|fylke)</code> or in other words <code>correlation=nlme::corAR1(form=~time|group)</code> to let the computer know what is the time variable and what is the group variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">glmmPQL</span>(y<span class="sc">~</span>yearMinus2000<span class="sc">+</span>sin365 <span class="sc">+</span> cos365, <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> fylke,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">family =</span> poisson, <span class="at">data =</span> d,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">correlation=</span>nlme<span class="sc">::</span><span class="fu">corAR1</span>(<span class="at">form=</span><span class="sc">~</span>dayOfSeries<span class="sc">|</span>fylke))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>iteration 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed-effects model fit by maximum likelihood
  Data: d 
  AIC BIC logLik
   NA  NA     NA

Random effects:
 Formula: ~1 | fylke
         (Intercept)  Residual
StdDev: 2.405145e-05 0.7195239

Correlation Structure: AR(1)
 Formula: ~dayOfSeries | fylke 
 Parameter estimate(s):
      Phi 
0.5240054 
Variance function:
 Structure: fixed weights
 Formula: ~invwt 
Fixed effects:  y ~ yearMinus2000 + sin365 + cos365 
                   Value   Std.Error    DF   t-value p-value
(Intercept)    1.2195477 0.010774796 43797  113.1852       0
yearMinus2000  0.0987065 0.000825226 43797  119.6115       0
sin365         1.3988945 0.002739109 43797  510.7116       0
cos365        -0.5169579 0.002292465 43797 -225.5030       0
 Correlation: 
              (Intr) yM2000 sin365
yearMinus2000 -0.979              
sin365        -0.149  0.001       
cos365         0.066 -0.001 -0.151

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-2.99731654 -0.70249782 -0.06736726  0.64264790  5.20296607 

Number of Observations: 43820
Number of Groups: 20 </code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="residual-analysis-1" class="level2" data-number="6.7">
<h2 data-number="6.7" class="anchored" data-anchor-id="residual-analysis-1"><span class="header-section-number">6.7</span> Residual analysis</h2>
<p>We see that the vast majority of the autoregression in the residuals has been removed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pacf</span>(<span class="fu">residuals</span>(fit1, <span class="at">type =</span> <span class="st">"normalized"</span>)) <span class="co"># this is for AR</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="600-multiple-areas-with-autocorrelation_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div style="page-break-after: always;"></div>
<p>We see that the vast majority of the autoregression in the residuals has been removed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">residuals</span>(fit1, <span class="at">type =</span> <span class="st">"normalized"</span>)) <span class="co"># this is for MA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="600-multiple-areas-with-autocorrelation_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" style="width:100.0%"></p>
</div>
</div>
<div style="page-break-after: always;"></div>
<p>We obtain the same estimates that we did in the last chapter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">&lt;-</span> <span class="fl">1.4007640</span> <span class="co"># sin coefficient</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>b2 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.5234863</span> <span class="co"># cos coefficient</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>amplitude <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(b1<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> b2<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">atan</span>(b1<span class="sc">/</span>b2) <span class="sc">*</span> <span class="dv">365</span><span class="sc">/</span><span class="dv">2</span><span class="sc">/</span>pi</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (p <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    peak <span class="ot">&lt;-</span> p</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    trough <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="dv">365</span><span class="sc">/</span><span class="dv">2</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    peak <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="dv">365</span><span class="sc">/</span><span class="dv">2</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    trough <span class="ot">&lt;-</span> p <span class="sc">+</span> <span class="dv">365</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (b1 <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> peak</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    peak <span class="ot">&lt;-</span> trough</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    trough <span class="ot">&lt;-</span> g</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">sprintf</span>(<span class="st">"amplitude is estimated as %s, peak is estimated as %s, trough is estimated as %s"</span>,<span class="fu">round</span>(amplitude,<span class="dv">2</span>),<span class="fu">round</span>(peak),<span class="fu">round</span>(trough)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "amplitude is estimated as 1.5, peak is estimated as 112, trough is estimated as 295"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">sprintf</span>(<span class="st">"true values are: amplitude: %s, peak: %s, trough: %s"</span>,<span class="fu">round</span>(AMPLITUDE,<span class="dv">2</span>),<span class="fu">round</span>(<span class="dv">365</span><span class="sc">/</span><span class="dv">4</span><span class="sc">+</span>SEASONAL_HORIZONTAL_SHIFT),<span class="fu">round</span>(<span class="dv">3</span><span class="sc">*</span><span class="dv">365</span><span class="sc">/</span><span class="dv">4</span><span class="sc">+</span>SEASONAL_HORIZONTAL_SHIFT)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "true values are: amplitude: 1.5, peak: 111, trough: 294"</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="stata-only-regression-with-robust-standard-errors" class="level2" data-number="6.8">
<h2 data-number="6.8" class="anchored" data-anchor-id="stata-only-regression-with-robust-standard-errors"><span class="header-section-number">6.8</span> (STATA ONLY) Regression with robust standard errors</h2>
<p>In STATA it is not possible to explicitly model autocorrelation in the residuals (with the exception of linear regression). Since most of our work deals with logistic and poisson regressions, we will be focusing on modelling strategies that work with all kinds of regressions.</p>
<p>The STATA approach to autocorrelation is to estimate more <code>robust</code> standard errors. That is, STATA makes the standard errors larger to account for the model mispecification. This is done through the <code>vce(robust)</code> option.</p>
<pre><code>// STATA CODE STARTS
meglm y yearminus2000 cos365 sin365 || fylke:, family(poisson) iter(10) vce(robust)
// STATA CODE ENDS</code></pre>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../qmd/500-multiple-areas-no-autocorrelation.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Panel data: multiple areas without autocorrelation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../qmd/700-exercises.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Exercises</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">Written by <a href="https://www.rwhite.no">Richard Aubrey White</a>.</div>
  </div>
</footer>



</body></html>